---
title: "Ahnen Familie Niemann - Karten"
format: 
  html: 
    theme: minty
    include-in-header: header.html
    code-fold: true
    highlight-style: github
    toc: true
    css: styles.css
    grid:
      body-width: 1100px
  # docx: default
execute:
  echo: false
  warning: false
---

```{r setup}
# librarys laden
packages <- c("tidyverse", "readxl", "leaflet", 
              "leaflet.minicharts", # Pfeile V1
              "sf", "rnaturalearth" # Pfeile V2
              , "geosphere"
              )
packages <- rev(packages)
for (package in packages) {
    if (!require(package, character.only = TRUE)) {
        install.packages(package, character.only = TRUE)
    }
    library(package, character.only = TRUE)
}
rm(packages, package)
```

```{r data}
# Daten laden

# V1 - ohne Generation
# data <- read_excel("./data/AHNEN_2026.xlsx", sheet = "Karten") # V1
# data <- data |>
#   reNAME(
#     lat1 = `LAT GebOrt`,
#     lon1 = `LON GebTag`,
#     lat2 = `LAT Sterbe`,
#     lon2 = `LON Sterbe`
#   )

# V2 - inkl. Generation
data <- read_excel("./data/Karten2026.xlsx")

# parse numbers
data <- data |> 
  mutate(
    lat1 = `LAT GEB` |> parse_number(),
    lon1 = `LON GEB` |> parse_number(),
    lat2 = `LAT TOD` |> parse_number(),
    lon2 = `LON TOD` |> parse_number()
    )

# berechne die Distanz zwischen Geburts- und Sterbeort in km
data <- data |>
  mutate(
    `Entf. GebOrt - SterbeOrt` = geosphere::distHaversine(
      matrix(c(lon1, lat1), ncol = 2),
      matrix(c(lon2, lat2), ncol = 2)
    ) / 1000
  )

# leichtes Rauschen
data <- data |>
  mutate(
    lat1x = jitter(lat1, factor = 1),
    lon1x = jitter(lon1, factor = 1),
    lat2x = jitter(lat2, factor = 1),
    lon2x = jitter(lon2, factor = 1)
  )
```

# Geburtsorte + Layer-Symbol: verschiedene Hintergründe


Varianten verschiedener Hintergründe

siehe auch hier http://leaflet-extras.github.io/leaflet-providers/preview/

hier ist auch mal diese Lizenz-Zeile unten ausgeblendet (für Druck besser?)

```{r }
leaflet(options = leafletOptions(attributionControl = FALSE),
data |> filter(!is.na(lon1))) |>
  addTiles() |>
  addProviderTiles("OpenStreetMap.DE") |>
  addTiles(
    urlTemplate = "https://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",
    attribution = '© dl-de/by-2-0',
    group = "TopPlusOpen.Color"
  ) |> 
    addProviderTiles("Esri.WorldImagery", group = "Satellit") |> 
  addProviderTiles("OpenTopoMap", group = "OpenTopoMap") |> 
  addProviderTiles("Esri.WorldImagery", group = "Esri.WorldImagery") |> 
  #addProviderTiles("MtbMap", group = "MtbMap") |> 
    addTiles(
    urlTemplate = "http://tile.mtbmap.cz/mtbmap_tiles/{z}/{x}/{y}.png",
    attribution = '© dl-de/by-2-0',
    group = "MtbMap"
  ) |> 
    addProviderTiles("CartoDB.PositronNoLabels", group = "CartoDB.PositronNoLabels") |> 
    addProviderTiles("Stadia.StamenToner", group = "Stadia.StamenToner") |> 
   #
   addLayersControl(
    baseGroups = c("TopPlusOpen.Color", "OpenStreetMap", "Satellit", "OpenTopoMap", "Esri.WorldImagery", "MtbMap", "CartoDB.PositronNoLabels",
    "Stadia.StamenToner"),
    position = "topleft"
  ) |> 
  addCircleMarkers(~lon1x, ~lat1x, radius = 4,
                   fillColor = "green", fillOpacity = 0.7,
                   weight = 1, popup = ~str_c(VORNAME, " ", NAME))
```
\

# Geburtsorte nach LINIE

## V1 - inverser Rand 

```{r }
col <- c("red", "blue")
lev <- unique(data$LINIE)
lev <- lev[!is.na(lev)]
cols <- colorFactor(palette = col, unique(na.omit(data$LINIE)))

leaflet(data |> filter(!is.na(lon1))) |>
  addTiles() |>
  #addProviderTiles("OpenStreetMap.DE") |>
  addTiles(
    urlTemplate = "https://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",
    attribution = '© dl-de/by-2-0',
    group = "TopPlusOpen.Color"
  ) |> 
  addCircleMarkers(
    ~lon1x,
    ~lat1x,
    radius = 3,
    fillColor = ~ cols(LINIE),
    color = c("red", "blue"),
    fillOpacity = 0.8,
    weight = 1,
    popup = ~ str_c(VORNAME, " ", NAME)
  ) |>
  addLegend(
    'bottomright',
    pal = cols,
    values = lev,
    title = 'LINIE',
    opacity = 1
  )

```
## V2 schwarzer Rand

```{r }
  leaflet(data |> filter(!is.na(lon1))) |>
  addTiles() |>
  addTiles(
    urlTemplate = "https://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",
    attribution = '© dl-de/by-2-0',
    group = "TopPlusOpen.Color"
  ) |> 
  addCircleMarkers(
    ~lon1x,
    ~lat1x,
    radius = 3,
    fillColor = ~ cols(LINIE),
    color = c("black", "black"),
    fillOpacity = 0.8,
    weight = 1,
    popup = ~ str_c(VORNAME, " ", NAME)
  ) |>
  addLegend(
    'bottomright',
    pal = cols,
    values = lev,
    title = 'LINIE',
    opacity = 1
  )
```

## V3 kein Rand

```{r }
  leaflet(data |> filter(!is.na(lon1))) |>
  addTiles() |>
  addTiles(
    urlTemplate = "https://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",
    attribution = '© dl-de/by-2-0',
    group = "TopPlusOpen.Color"
  ) |> 
  addCircleMarkers(
    ~lon1x,
    ~lat1x,
    radius = 3,
    fillColor = ~ cols(LINIE),
    color = none,
    fillOpacity = 0.8,
    weight = 1,
    popup = ~ str_c(VORNAME, " ", NAME)
  ) |>
  addLegend(
    'bottomright',
    pal = cols,
    values = lev,
    title = 'LINIE',
    opacity = 1
  )
```

# Pfeile V1

Erster Versuch mit leaflet.minicharts -> nicht optimal

(Entfernung Geburts-/Sterbeort > 20 km)

```{r}
#library(leaflet.minicharts)
dat <- data|> 
  filter(!is.na(lon1) & 
  !is.na(lon2) &
  `Entf. GebOrt - SterbeOrt` > 20)
leaflet(dat) |>
  addTiles() |>
  addFlows(
    lng0 = dat$lon1x, lat0 = dat$lat1x, # Startpunkte
    lng1 = dat$lon2x, lat1 = dat$lat2x, # Endpunkte
    color = "blue",
    flow = 1,              # Bestimmt die Richtung (1 = Start zu Ende)
    minThickness = 2, 
    maxThickness = 2       # Konstante Dicke
  )

```

# Pfeile V2

Mit ggplot, eingefärbt nach LINIE

```{r}
germany <- ne_countries(scale = "medium", country = "Germany", returnclass = "sf")

ggplot() +
  geom_sf(data = germany, fill = "grey95") + 
  labs(title = "Geburtsort ---> Sterbeort") +
  geom_curve(
    data = dat,
    aes(
      x = lon1x, y = lat1x,
      xend = lon2x, yend = lat2x,
      color = LINIE
    ),
    arrow = arrow(length = unit(0.2, "cm"), type = "closed"),
    #color = "blue",
    curvature = 0.2,
    size = 0.7
  ) +
  # Legende für die Farben der Pfeile
  scale_color_manual(
    #NAME = "LINIE",
    values = c("Vaterlinie" = "blue", "Mutterlinie" = "red")
  ) +
  theme_minimal() +
  # alle gitternetzLINIEn und Achsen entfernen
  theme(
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )
```

